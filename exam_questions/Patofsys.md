## Patofsys

[1. Что такое распределённая система?](#1-что-такое-распределённая-система)

[2. Какие проблемы возникают при проектировании распределённых систем?](#2-какие-проблемы-возникают-при-проектировании-распределённых-систем)

[3. Что такое распределённые транзакции и какие сложности с ними связаны?](#3-что-такое-распределённые-транзакции-и-какие-сложности-с-ними-связаны)

[4. Что такое двухфазный коммит (2PC) и как он работает?](#4-что-такое-двухфазный-коммит-2pc-и-как-он-работает)

[5. Что такое трёхфазный коммит (3PC) и чем он отличается от двухфазного?](#5-что-такое-трёхфазный-коммит-3pc-и-чем-он-отличается-от-двухфазного)

[6. Что такое паттерн "Согласованность, доступность и отказоустойчивость" (CAP Theorem)?](#6-что-такое-паттерн-согласованность-доступность-и-отказоустойчивость-cap-theorem)

[7. Что такое паттерн "Event Sourcing" в контексте распределённых систем?](#7-что-такое-паттерн-event-sourcing-в-контексте-распределённых-систем)

[8. Что такое паттерн "Saga" и как он решает проблему распределённых транзакций?](#8-что-такое-паттерн-saga-и-как-он-решает-проблему-распределённых-транзакций)

[9. Как обеспечить согласованность данных при сетевых сбоях и отказах?](#9-как-обеспечить-согласованность-данных-при-сетевых-сбоях-и-отказах)

[10. В чем заключается принцип "BASE" в распределённых системах?](#10-в-чем-заключается-принцип-base-в-распределённых-системах)

# 1. Что такое распределённая система?

Распределённая система — это когда несколько компьютеров или программ работают вместе, чтобы выполнить одну задачу. Эти
компьютеры могут находиться в разных местах, но они общаются между собой через сеть (например, интернет). Главное, чтобы
всё работало как единое целое, даже если части системы находятся далеко друг от друга.

Пример: представь, что у тебя есть интернет-магазин. Один сервис отвечает за поиск товаров, другой — за оформление
заказов, а третий — за оплату. Все они работают на разных компьютерах, но взаимодействуют друг с другом, чтобы ты мог
найти товар, заказать его и оплатить. Это и есть распределённая система.

[К оглавлению](#Patofsys)

# 2. Какие проблемы возникают при проектировании распределённых систем?

+ Сбои и отказы
  В распределённых системах много компонентов, и если один из них сломается, это может повлиять на всю систему.
  Например, если один сервер упадёт, другие должны продолжать работать.
  Как сказать: "Нужно учитывать, что в распределённых системах что-то может сломаться, и система должна быть устойчивой
  к таким сбоям."

+ Задержки в сети
  Компоненты системы общаются через сеть, а сеть может быть медленной или ненадёжной. Это может привести к задержкам в
  работе.
  Как сказать: "Важно помнить, что передача данных между узлами занимает время, и это может влиять на скорость работы
  системы."

+ Согласованность данных
  Если данные хранятся на нескольких узлах, они могут стать несогласованными. Например, один сервер обновил информацию,
  а другой ещё нет.
  Как сказать: "Нужно следить, чтобы данные на всех узлах были актуальными и согласованными, даже если что-то идёт не
  так."

+ Масштабируемость
  Когда нагрузка на систему растёт, нужно добавлять новые узлы, но это может быть сложно. Например, если система не
  справляется с большим количеством пользователей, её нужно расширять.
  Как сказать: "Система должна легко масштабироваться, чтобы справляться с увеличением нагрузки."

+ Безопасность
  Поскольку данные передаются по сети, их могут перехватить или украсть.
  Как сказать: "Важно защищать данные, которые передаются между узлами, чтобы их не могли украсть."

+ Сложность отладки
  В распределённых системах сложнее найти ошибку, потому что проблема может быть в любом из узлов или в сети.
  Как сказать: "Отладка таких систем сложнее, потому что нужно проверять множество компонентов и их взаимодействие."

[К оглавлению](#Patofsys)

# 3. Что такое распределённые транзакции и какие сложности с ними связаны?

+ Распределённые транзакции — это когда операция затрагивает несколько баз данных или серверов. Например, перевод денег
  между счетами в разных банках. Важно, чтобы всё прошло либо целиком, либо не прошло вообще.
+ Основные сложности — это согласованность данных (чтобы не было частичного выполнения), задержки в сети, координация
  между узлами и отказы оборудования.
+ Чтобы справиться с этим, используют алгоритмы вроде двухфазного commit (2PC), где сначала все узлы голосуют за
  выполнение транзакции, а потом подтверждают её. Но это может быть медленно, поэтому иногда используют другие подходы,
  например, сагу (Saga), где транзакция разбивается на этапы с возможностью отката.
+ Главное — обеспечить атомарность (всё или ничего) и согласованность данных, даже если что-то идёт не так.

PS: В двухфазном commit (2PC) узлы голосуют за выполнение транзакции. Сначала координатор спрашивает всех участников,
могут ли они выполнить свою часть. Если все говорят 'Да', координатор подтверждает выполнение. Если хотя бы один
говорит 'Нет', транзакция отменяется. Это гарантирует, что либо всё выполнится, либо ничего. Но есть сложности:
например, если координатор упадёт, участники могут зависнуть в ожидании.

[К оглавлению](#Patofsys)

# 4. Что такое двухфазный коммит (2PC) и как он работает?

Двухфазный коммит (2PC) — это алгоритм для выполнения распределённых транзакций. Он работает в две фазы. Сначала
координатор(главный узел, который управляет процессом) спрашивает всех участников(узлы, которые выполняют части
транзакции), могут ли они выполнить свою часть транзакции. Если все говорят 'Да', координатор
подтверждает выполнение. Если хотя бы один говорит 'Нет', транзакция отменяется. Это гарантирует, что либо всё
выполнится, либо ничего. Но есть сложности: например, если координатор упадёт, участники могут зависнуть в ожидании.

### Если координатор падает, участники могут остаться в подвешенном состоянии. Чтобы справиться с этим, можно использовать несколько подходов:

+ Участники могут ждать ответа от координатора в течение определённого времени, а затем самостоятельно откатить
  транзакцию.

+ Можно использовать резервный координатор, который возьмёт на себя управление, если основной координатор упадёт.

+ Когда координатор восстанавливается, он может запросить состояние у участников и принять решение на основе их ответов.

+ Также можно использовать журналы, чтобы координатор и участники могли восстановить своё состояние после сбоя.

[К оглавлению](#Patofsys)

# 5. Что такое трёхфазный коммит (3PC) и чем он отличается от двухфазного?

Трёхфазный коммит (3PC) — это улучшенная версия двухфазного коммита (2PC). Он добавляет дополнительную фазу — '
Pre-Commit', чтобы участники не зависали в неопределённом состоянии, когда координатор падает. В 3PC сначала все
участники голосуют, затем получают предварительное решение, и только после этого выполняют транзакцию. Это делает
систему более отказоустойчивой, но сложнее в реализации.

### Главное преимущество 3PC в том, что участники не зависают в неопределённом состоянии:

+ Если координатор падает после фазы "Pre-Commit", участники знают, что все проголосовали "Yes", и могут самостоятельно
  завершить транзакцию.

+ Если координатор падает до фазы "Pre-Commit", участники могут откатить транзакцию, так как не было предварительного
  согласия.

[К оглавлению](#Patofsys)

# 6. Что такое паттерн "Согласованность, доступность и отказоустойчивость" (CAP Theorem)?

CAP-теорема говорит, что в распределённой системе можно гарантировать только два из трёх свойств: Согласованность (
Consistency), Доступность (Availability) и Устойчивость к разделению (Partition Tolerance). Например, если система
должна быть доступной и устойчивой к сбоям сети, то придётся пожертвовать согласованностью данных. Это важно учитывать
при проектировании распределённых систем, чтобы выбрать подходящий компромисс.

+ Согласованность (Consistency): Все узлы системы видят одни и те же данные в одно и то же время.

+ Доступность (Availability): Система всегда отвечает на запросы, даже если некоторые узлы недоступны.

+ Устойчивость к разделению (Partition Tolerance): Система продолжает работать, даже если связь между узлами нарушена (
  например, из-за сбоя сети).

### Как это работает на практике?

+ CA (Согласованность + Доступность):
  Система всегда возвращает актуальные данные и всегда доступна.
  Но если сеть разделяется (например, из-за сбоя), система не сможет работать.

Пример: традиционные реляционные базы данных (например, PostgreSQL, MySQL).

+ CP (Согласованность + Устойчивость к разделению):
  Система всегда возвращает актуальные данные и работает при сбоях сети.
  Но если сеть разделяется, некоторые узлы могут стать недоступными.

Пример: распределённые базы данных, такие как MongoDB (в некоторых конфигурациях) или Google Spanner.

+ AP (Доступность + Устойчивость к разделению):
  Система всегда доступна и работает при сбоях сети.
  Но данные могут быть несогласованными (например, разные узлы могут показывать разные данные).

Пример: Cassandra, DynamoDB.

[К оглавлению](#Patofsys)

# 7. Что такое паттерн "Event Sourcing" в контексте распределённых систем?

Event Sourcing (хранение событий) — это подход к проектированию систем, при котором все изменения состояния системы
сохраняются как последовательность событий (events). Вместо того чтобы хранить только текущее состояние данных (как в
традиционных базах данных), система сохраняет каждое действие (событие), которое привело к этому состоянию. Это
позволяет воспроизвести состояние системы в любой момент времени, просто "проиграв" все события с начала.

### Преимущества Event Sourcing:

+ Все изменения сохраняются, что упрощает аудит и отладку.
+ Можно восстановить состояние системы на любой момент времени.
+ События можно обрабатывать асинхронно, что упрощает масштабирование.
+ Легко добавлять новые функции, которые реагируют на уже произошедшие события.

### Сложности Event Sourcing:

+ Сложность реализации: Нужно продумать, как хранить и обрабатывать события.
+ Производительность: Восстановление состояния может быть медленным, если событий очень много.
+ Согласованность: Нужно следить за тем, чтобы события применялись в правильном порядке.

[К оглавлению](#Patofsys)

# 8. Что такое паттерн "Saga" и как он решает проблему распределённых транзакций?

Saga — это паттерн для управления распределёнными транзакциями. Он разбивает одну большую транзакцию на несколько
маленьких шагов, каждый из которых выполняется как локальная транзакция. Если один из шагов завершается неудачно, Saga
запускает компенсирующие действия, чтобы откатить уже выполненные шаги.
Это позволяет избежать блокировок и длительных
ожиданий, которые возникают в двухфазном коммите (2PC). Например, в системе заказов Saga может отменить заказ и вернуть
деньги, если что-то пошло не так.

### Как это работает?

Шаги Saga:

+ Транзакция разбивается на несколько независимых шагов. Каждый шаг выполняется как локальная транзакция на своём узле.

Например, в системе заказов шаги могут быть такими: "Создать заказ", "Зарезервировать товар", "Списать деньги с карты".

+ Компенсирующие действия:
  Для каждого шага определяется компенсирующее действие, которое откатывает изменения, если транзакция завершается
  неудачно.

Например: "Отменить заказ", "Вернуть товар на склад", "Вернуть деньги на карту".

### Saga может управляться двумя способами:

+ Хореография (Choreography): Каждый шаг самостоятельно запускает следующий шаг или компенсацию.

+ Оркестрация (Orchestration): Центральный координатор (оркестратор) управляет выполнением шагов и компенсаций.

[К оглавлению](#Patofsys)

# 9. Как обеспечить согласованность данных при сетевых сбоях и отказах?

Чтобы обеспечить согласованность данных при сбоях, можно использовать несколько подходов:

+ Репликацию данных, чтобы информация хранилась на нескольких узлах.
+ Кворумы, чтобы большинство узлов подтверждало каждое изменение.
+ Механизмы согласованности, такие как строгая согласованность или согласованность в конечном счёте.
+ Идемпотентные операции, чтобы повторные запросы не вызывали ошибок.(Операции делаются так, чтобы их повторное
  выполнение не вызывало проблем. Например, если запрос на списание денег пришёл дважды, система должна списать деньги
  только один раз.)
+ Компенсирующие транзакции (например, Saga), чтобы откатывать изменения при ошибках. (Если транзакция не может быть
  завершена, система выполняет компенсирующие действия, чтобы откатить изменения.
  Пример: Если перевод денег не удался, система возвращает деньги на исходный счёт.)
+ Журналы (логи) для восстановления данных после сбоев.

Например, в системе переводов можно использовать репликацию и кворумы, чтобы данные оставались согласованными даже при
отказе одного из серверов.

[К оглавлению](#Patofsys)

# 10. В чем заключается принцип "BASE" в распределённых системах?

BASE — это набор принципов для распределённых систем, которые делают их более доступными и масштабируемыми. Он
расшифровывается как:
+ Basically Available — система всегда отвечает на запросы, даже если часть узлов недоступна.
+ Soft state — состояние системы может меняться со временем без внешних запросов.
+ Eventual consistency — данные на всех узлах станут согласованными через некоторое время.

Например, в социальной сети посты могут появляться у пользователей не сразу, но система продолжает работать даже при
сбоях. Это позволяет системе быть более доступной и масштабируемой, но временно данные могут быть несогласованными.

[К оглавлению](#Patofsys)